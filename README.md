# WhatsApp Reminder Bot

WhatsApp Reminder Bot - это приложение, созданное на базе FastAPI и Celery, которое использует Twilio для отправки напоминаний через WhatsApp.

## ТЗ
[Смотреть на гугл диск](https://docs.google.com/document/d/1GbAmRXWzPMxI-aeuYWF_92962LQ8WwYu/edit?usp=sharing&ouid=106308963898479999770&rtpof=true&sd=true)

## Краткое видео работы бота
[Видео в папке на гугл диск](https://drive.google.com/drive/folders/1tP7EQBeLUPQ4aaxGJX6E64jdfrjk6mZ-?usp=sharing)

## Используемые технологии

- **FastAPI**: асинхронный веб-фреймворк для создания API.
- **Celery**: система управления отложенными задачами.
- **Redis**: брокер сообщений и бэкенд для Celery.
- **Twilio**: платформа для отправки сообщений WhatsApp.
- **Docker**: контейнеризация приложений.
- **Pytest**: тестирование.
- **Ngrok**: публичный uri для обращения Twilio к нашему локальному приложению.

## Требования

- Docker и Docker Compose установлены на вашей машине.
- Учетная запись Twilio для отправки сообщений.
- Ngrok для связи Twilio с нашим локальным приложением

## Установка и запуск

### Шаг 1: Клонируйте репозиторий

```bash
git clone https://github.com/your-username/whatsapp-reminder-bot.git
cd whatsapp-reminder-bot
```

Шаг 2: Настройте переменные окружения
Создайте файл .env в корне проекта со следующим содержимым:
```env
REDIS_HOST=redis
REDIS_PORT=6379
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0
TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_PHONE_NUMBER=your_twilio_phone_number
TWILIO_WHATSAPP_NUMBER=whatsapp:your_twilio_whatsapp_number
HOST=0.0.0.0
PORT=8000
```

Шаг 3: Запустите приложение

Используйте Docker Compose для запуска всех сервисов:
```bash
docker-compose up --build
```
Приложение будет доступно по адресу http://localhost:8000

## API

Вебхуки
POST /webhooks/twilio
Используется Twilio для отправки сообщений. Пример тела запроса:
```json
{
  "From": "whatsapp:+1234567890",
  "Body": "/add remind me to buy groceries at 2024-06-16 21:00 in Europe/Moscow"
}
```
**Команды**

* /start: Начало работы с ботом. Отправляет приветственное сообщение и список доступных команд.
* /help: Показать список доступных команд.
* /list: Показать все текущие напоминания.
* /delete [ID or index]: Удалить конкретное напоминание по ID или индексу.
* /add remind me to [task] at [YYYY-MM-DD HH:MM] in [Timezone]: Добавить новое напоминание. 

## Тестирование

Для запуска тестов используйте Pytest. Убедитесь, что у вас установлен pytest-mock:
```bash
pip install pytest pytest-mock
```
Запустите тесты:
```bash
pytest src/tests
```
## Краткое описание решения задачи
### Основные компоненты решения:

**FastAPI:**

Основной веб-фреймворк, который используется для создания API, обрабатывающего входящие запросы и маршруты для взаимодействия с ботом.
Маршрут /webhooks/twilio обрабатывает вебхуки от Twilio, позволяя принимать и интерпретировать сообщения от пользователей.

**Celery:**

Система для асинхронной обработки задач, таких как отправка напоминаний. Celery позволяет планировать задачи на будущее и отправлять напоминания в указанное пользователями время.
Настроен для работы с Redis в качестве брокера сообщений и бэкенда.

**Redis:**

Используется как хранилище данных для напоминаний и брокер сообщений для Celery.
Хранит информацию о напоминаниях, таких как текст, время и часовой пояс пользователя, 
служит инстурментом для организации очередей с помощью Celery.

**Twilio:**

Платформа для отправки сообщений через WhatsApp. С помощью Twilio API осуществляется отправка сообщений пользователям.
Взаимодействие с Twilio реализовано в twilio_client.py, где отправляются сообщения с напоминаниями.

**Docker:**

Используется для контейнеризации приложений, что обеспечивает их изоляцию и упрощает деплоймент.
Все сервисы проекта, включая FastAPI, Celery и Redis, развертываются в отдельных контейнерах.

**Pytest:**

Инструмент для тестирования, используемый для написания и выполнения тестов, обеспечивающих корректную работу приложения.

**Ngrok:**

Предоставляет публичный URI для локального приложения, что позволяет Twilio взаимодействовать с нашим приложением, работающим на локальной машине.

## Основной функционал бота:

### Добавление напоминаний:

Пользователи могут добавлять напоминания с помощью команды /add remind me to [task] at [YYYY-MM-DD HH:MM] in [Timezone].
Введенные данные обрабатываются и сохраняются в Redis, а Celery планирует отправку напоминания в указанное время.

### Просмотр списка напоминаний:

Команда /list позволяет пользователям просматривать все текущие напоминания.
Информация о напоминаниях извлекается из Redis и отправляется пользователю.

### Удаление напоминаний:

Пользователи могут удалять конкретные напоминания по ID или индексу с помощью команды /delete [ID or index].
Напоминания удаляются из Redis, и связанные задачи в Celery отменяются, чтобы предотвратить отправку удаленного напоминания.

### Основные модули проекта:

- twilio_webhook.py: Обрабатывает входящие запросы от Twilio и маршрутизирует команды пользователя.
- reminder_service.py: Основная логика для управления напоминаниями, включая добавление, удаление и извлечение данных.
- twilio_client.py: Взаимодействие с Twilio API для отправки сообщений.
- celery_client.py: Настройка и определение задач Celery.
- redis_client.py: Настройка и определение Redis.
